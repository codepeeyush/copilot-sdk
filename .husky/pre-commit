#!/bin/sh
#
# Gitleaks + Lint-Staged Pre-Commit Hook
#

# Add homebrew to PATH for non-interactive shells
export PATH="/opt/homebrew/bin:$PATH"

echo "üîç Running Gitleaks to check for secrets..."

# Check if gitleaks is installed
if ! command -v gitleaks &> /dev/null; then
    echo ""
    echo "‚ùå ERROR: Gitleaks is not installed!"
    echo ""
    echo "To install gitleaks:"
    echo "  macOS:   brew install gitleaks"
    echo "  Linux:   https://github.com/gitleaks/gitleaks#installing"
    echo ""
    exit 1
fi

# Run gitleaks on staged changes
gitleaks protect --staged --verbose --config=.gitleaks.toml

if [ $? -eq 1 ]; then
    echo ""
    echo "‚ùå COMMIT BLOCKED: Secrets or .env files detected!"
    echo ""
    echo "To fix:"
    echo "  1. Remove sensitive data from staged files"
    echo "  2. Use .env.example instead of .env files"
    echo "  3. Add false positives to .gitleaks.toml allowlist"
    echo ""
    exit 1
fi

echo "‚úÖ Gitleaks scan passed!"
echo ""

# Run lint-staged
pnpm exec lint-staged
